<!doctype html>
<html>
<head>
    <title>Shell</title>

    <link rel="stylesheet" href="/static/xterm/xterm.css" />
    <link rel="stylesheet" href="/static/xterm/addons/fullscreen/fullscreen.css" />

    <script src="/static/xterm/xterm.js"></script>
    <script src="/static/xterm/addons/fit/fit.js" ></script>
    <script src="/static/xterm/addons/webLinks/webLinks.js" ></script>
    <script src="/static/xterm/addons/fullscreen/fullscreen.js" ></script>

    <style type="text/css">
        body {
            font-family: helvetica, sans-serif, arial;
            font-size: 1em;
            color: #111;
        }
        #terminal-container .terminal {
            background-color: #111;
            color: #fafafa;
            padding: 2px;
        }
        #terminal-container .terminal .terminal-cursor {
            background-color: #fafafa;
        }
    </style>
</head>
<body>
<div id="terminal"></div>
<script>
    Terminal.applyAddon(fit);
    Terminal.applyAddon(fullscreen);
    Terminal.applyAddon(webLinks);

    var term;
    var websocket = new WebSocket("ws://" + window.location.hostname + ":" + window.location.port + "/ws/shell");
    websocket.binaryType = "arraybuffer";

    websocket.onopen = function(evt) {
        term = new Terminal({
            screenKeys: true,
            useStyle: true,
            cursorBlink: true,
        });
        term.on('data', function(data) {
            websocket.send(new TextEncoder().encode("\x00" + data));
        });
        term.on('resize', function(evt) {
            websocket.send(new TextEncoder().encode("\x01" + JSON.stringify({cols: evt.cols, rows: evt.rows})))
        });
        term.on('title', function(title) {
            document.title = title;
        });
        term.open(document.getElementById('terminal'));
        term.fit();
        websocket.onmessage = function(evt) {
            if (evt.data instanceof ArrayBuffer) {
                term.write(ab2str(evt.data));
            } else {
                alert(evt.data)
            }
        };
        websocket.onclose = function(evt) {
            term.write("Session terminated");
            term.destroy();
        };
        websocket.onerror = function(evt) {
            if (typeof console.log == "function") {
                console.log(evt)
            }
        }
    };

    function ab2str(buf) {
        return String.fromCharCode.apply(null, new Uint8Array(buf));
    }
</script>
</body>
</html>